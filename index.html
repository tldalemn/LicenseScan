<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>License Scanner</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@300;400;500&display=swap');

  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --card: #1a2234;
    --accent: #00e5ff;
    --accent2: #7c3aed;
    --green: #10b981;
    --yellow: #f59e0b;
    --red: #ef4444;
    --text: #f1f5f9;
    --muted: #64748b;
    --border: rgba(255,255,255,0.07);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Subtle grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .app {
    position: relative;
    z-index: 1;
    max-width: 480px;
    margin: 0 auto;
    padding: 0 0 80px;
  }

  /* Header */
  header {
    padding: 24px 20px 16px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(0,229,255,0.05) 0%, transparent 100%);
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 18px;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  .logo span {
    color: var(--text);
    opacity: 0.5;
  }

  .record-count {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 4px 12px;
    font-size: 11px;
    color: var(--muted);
  }

  .record-count strong {
    color: var(--accent);
  }

  /* Tabs */
  .tabs {
    display: flex;
    margin: 20px 20px 0;
    background: var(--card);
    border-radius: 12px;
    padding: 4px;
    border: 1px solid var(--border);
  }

  .tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.5px;
    border-radius: 9px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--muted);
    border: none;
    background: none;
  }

  .tab.active {
    background: var(--accent);
    color: #000;
  }

  /* Panels */
  .panel { display: none; padding: 20px; }
  .panel.active { display: block; }

  /* Scanner section */
  .scan-area {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 20px;
  }

  .scan-header {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .scan-icon {
    width: 32px;
    height: 32px;
    background: rgba(0,229,255,0.1);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .scan-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 14px;
  }

  .scan-sub {
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
  }

  #video-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16/9;
    background: #000;
    display: none;
  }

  #video-container.active { display: block; }

  #video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .scan-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .scan-frame {
    width: 80%;
    height: 60%;
    border: 2px solid var(--accent);
    border-radius: 8px;
    box-shadow: 0 0 0 2000px rgba(0,0,0,0.5);
    position: relative;
  }

  .scan-line {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent);
    animation: scanLine 1.2s ease-in-out infinite;
  }

  @keyframes scanLine {
    0% { top: 0; }
    50% { top: calc(100% - 2px); }
    100% { top: 0; }
  }

  .scan-frame.detected {
    border-color: var(--green) !important;
    box-shadow: 0 0 0 2000px rgba(0,0,0,0.5), 0 0 20px var(--green);
    animation: pulse-green 0.4s ease;
  }

  @keyframes pulse-green {
    0% { border-color: var(--accent); }
    100% { border-color: var(--green); }
  }

  .torch-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    padding: 8px 12px;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    z-index: 10;
  }

  .torch-btn.on { background: rgba(245,158,11,0.7); }

  .scan-status {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: var(--accent);
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    padding: 4px 12px;
    border-radius: 20px;
    letter-spacing: 1px;
    white-space: nowrap;
  }

  .zoom-hint {
    background: rgba(0,229,255,0.07);
    border: 1px solid rgba(0,229,255,0.15);
    border-radius: 10px;
    padding: 10px 14px;
    margin: 0 0 14px;
    font-size: 11px;
    color: var(--muted);
    line-height: 1.6;
    display: none;
  }

  .zoom-hint.visible { display: block; }
  .zoom-hint strong { color: var(--accent); }

  .scan-label {
    position: absolute;
    bottom: -28px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: var(--accent);
    white-space: nowrap;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .scan-placeholder {
    padding: 40px 20px;
    text-align: center;
    color: var(--muted);
  }

  .scan-placeholder .big-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  .scan-placeholder p {
    font-size: 12px;
    line-height: 1.6;
  }

  .scan-actions {
    padding: 16px;
    display: flex;
    gap: 10px;
  }

  .btn {
    flex: 1;
    padding: 14px;
    border-radius: 10px;
    border: none;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .btn-primary {
    background: var(--accent);
    color: #000;
  }

  .btn-primary:active { transform: scale(0.97); }

  .btn-secondary {
    background: var(--card);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-danger {
    background: rgba(239,68,68,0.15);
    color: var(--red);
    border: 1px solid rgba(239,68,68,0.3);
  }

  /* Parsed info */
  #parsed-info {
    background: var(--card);
    border: 1px solid rgba(0,229,255,0.2);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 20px;
    display: none;
  }

  #parsed-info.visible { display: block; }

  .info-title {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    color: var(--accent);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .info-field {
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
    padding: 10px;
    border: 1px solid var(--border);
  }

  .info-field.full { grid-column: 1 / -1; }

  .field-label {
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .field-value {
    font-size: 13px;
    color: var(--text);
    word-break: break-word;
  }

  /* Category selector */
  .category-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 20px;
    display: none;
  }

  .category-section.visible { display: block; }

  .category-label {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    color: var(--text);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .category-btns {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  .cat-btn {
    padding: 16px 8px;
    border-radius: 12px;
    border: 2px solid var(--border);
    background: rgba(255,255,255,0.02);
    color: var(--muted);
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 11px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .cat-btn .cat-icon { font-size: 24px; }

  .cat-btn.selected.how {
    border-color: var(--green);
    background: rgba(16,185,129,0.1);
    color: var(--green);
  }

  .cat-btn.selected.electronics {
    border-color: var(--accent);
    background: rgba(0,229,255,0.1);
    color: var(--accent);
  }

  .cat-btn.selected.recycle {
    border-color: var(--yellow);
    background: rgba(245,158,11,0.1);
    color: var(--yellow);
  }

  /* Save button */
  #save-btn {
    width: 100%;
    padding: 18px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 14px;
    letter-spacing: 1px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: none;
    text-transform: uppercase;
  }

  #save-btn.visible { display: block; }
  #save-btn:active { transform: scale(0.98); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--green);
    color: #000;
    padding: 12px 24px;
    border-radius: 50px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    opacity: 0;
    transition: all 0.3s;
    z-index: 100;
    white-space: nowrap;
  }

  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Records table */
  .records-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .records-title {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 16px;
  }

  .clear-btn {
    font-size: 11px;
    color: var(--red);
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid rgba(239,68,68,0.3);
  }

  .record-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 10px;
    transition: border-color 0.2s;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .record-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }

  .record-name {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 14px;
  }

  .record-cat {
    font-size: 10px;
    padding: 4px 10px;
    border-radius: 20px;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .cat-how { background: rgba(16,185,129,0.15); color: var(--green); }
  .cat-electronics { background: rgba(0,229,255,0.15); color: var(--accent); }
  .cat-recycle { background: rgba(245,158,11,0.15); color: var(--yellow); }
  .cat-none { background: rgba(100,116,139,0.15); color: var(--muted); }

  .record-address {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.5;
  }

  .record-time {
    font-size: 10px;
    color: var(--muted);
    margin-top: 8px;
    opacity: 0.6;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }

  .empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
  .empty-state p { font-size: 12px; line-height: 1.7; }

  /* Upload fallback */
  #upload-input { display: none; }
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="header-top">
      <div class="logo">SCAN<span>/</span>ID</div>
      <div class="record-count">Records: <strong id="count">0</strong></div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('scan')">üì∑ Scan</button>
    <button class="tab" onclick="switchTab('records')">üìã Records</button>
  </div>

  <!-- SCAN PANEL -->
  <div class="panel active" id="panel-scan">

    <div class="scan-area">
      <div class="scan-header">
        <div class="scan-icon">üìÑ</div>
        <div>
          <div class="scan-title">Driver's License</div>
          <div class="scan-sub">Point camera at PDF417 barcode on back</div>
        </div>
      </div>

      <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
        <button class="torch-btn" id="torch-btn" onclick="toggleTorch()" title="Toggle flashlight">üî¶</button>
        <div class="scan-overlay">
          <div class="scan-frame" id="scan-frame">
            <div class="scan-line" id="scan-line"></div>
            <div class="scan-label">Align barcode within frame</div>
          </div>
        </div>
        <div class="scan-status" id="scan-status">SCANNING...</div>
      </div>

      <div class="zoom-hint" id="zoom-hint">
        üí° <strong>Tips:</strong> Hold 6‚Äì10 inches away ¬∑ Keep steady ¬∑ Good lighting helps ¬∑ Barcode is on the <strong>back</strong> of the license
      </div>

      <div id="scan-placeholder" class="scan-placeholder">
        <div class="big-icon">ü™™</div>
        <p>Tap <strong>Start Camera</strong> and point it at the <strong>barcode on the back</strong> of the driver's license.</p>
      </div>

      <div class="scan-actions">
        <button class="btn btn-primary" id="scan-btn" onclick="startCamera()">Start Camera</button>
        <button class="btn btn-secondary" onclick="document.getElementById('upload-input').click()">Upload Image</button>
        <button class="btn btn-secondary" onclick="useDemo()">Demo</button>
      </div>
    </div>

    <input type="file" id="upload-input" accept="image/*" onchange="handleUpload(event)">

    <!-- Parsed Info -->
    <div id="parsed-info">
      <div class="info-title">‚úì Parsed Information</div>
      <div class="info-grid" id="info-grid"></div>
    </div>

    <!-- Category Selection -->
    <div class="category-section" id="category-section">
      <div class="category-label">
        üóÇÔ∏è Select Category
      </div>
      <div class="category-btns">
        <button class="cat-btn" id="cat-how" onclick="selectCategory('how')">
          <span class="cat-icon">üè†</span>
          HOW
        </button>
        <button class="cat-btn" id="cat-electronics" onclick="selectCategory('electronics')">
          <span class="cat-icon">üîå</span>
          ELECTRONICS
        </button>
        <button class="cat-btn" id="cat-recycle" onclick="selectCategory('recycle')">
          <span class="cat-icon">‚ôªÔ∏è</span>
          RECYCLE
        </button>
      </div>
    </div>

    <button class="btn" id="save-btn" onclick="saveRecord()">üíæ Save Record</button>

  </div>

  <!-- RECORDS PANEL -->
  <div class="panel" id="panel-records">
    <div class="records-header">
      <div class="records-title">Records</div>
      <button class="clear-btn" onclick="clearAll()">Clear All</button>
    </div>
    <div id="records-list"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- ZXing barcode scanner library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/zxing-js/0.20.0/index.min.js" 
  onerror="console.log('ZXing not loaded, will use demo mode')"></script>

<script>
let stream = null;
let scanning = false;
let codeReader = null;
let parsedData = null;
let selectedCategory = null;
let scanInterval = null;

// ---- CAMERA ----
let torchOn = false;

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' },
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        focusMode: { ideal: 'continuous' },
        zoom: true
      }
    });
    const video = document.getElementById('video');
    video.srcObject = stream;
    document.getElementById('video-container').classList.add('active');
    document.getElementById('scan-placeholder').style.display = 'none';
    document.getElementById('zoom-hint').classList.add('visible');
    document.getElementById('scan-btn').textContent = 'Stop Camera';
    document.getElementById('scan-btn').onclick = stopCamera;
    scanning = true;

    // Enable autofocus if available
    const track = stream.getVideoTracks()[0];
    if (track.getCapabilities && track.getCapabilities().focusMode) {
      await track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }).catch(() => {});
    }

    startBarcodeDetection();
  } catch (e) {
    showToast('Camera error: ' + e.message, 'error');
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  scanning = false;
  torchOn = false;
  if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
  document.getElementById('video-container').classList.remove('active');
  document.getElementById('scan-placeholder').style.display = 'block';
  document.getElementById('zoom-hint').classList.remove('visible');
  document.getElementById('scan-btn').textContent = 'Start Camera';
  document.getElementById('scan-btn').onclick = startCamera;
  document.getElementById('torch-btn').classList.remove('on');
}

async function toggleTorch() {
  if (!stream) return;
  const track = stream.getVideoTracks()[0];
  const caps = track.getCapabilities ? track.getCapabilities() : {};
  if (!caps.torch) { showToast('Torch not supported on this device', 'info'); return; }
  torchOn = !torchOn;
  await track.applyConstraints({ advanced: [{ torch: torchOn }] }).catch(() => {});
  document.getElementById('torch-btn').classList.toggle('on', torchOn);
}

function enhanceFrame(ctx, w, h) {
  // Boost contrast and sharpen for better barcode reads
  const imageData = ctx.getImageData(0, 0, w, h);
  const d = imageData.data;
  // Increase contrast
  const factor = 1.4;
  const intercept = 128 * (1 - factor);
  for (let i = 0; i < d.length; i += 4) {
    d[i]   = Math.min(255, Math.max(0, d[i]   * factor + intercept));
    d[i+1] = Math.min(255, Math.max(0, d[i+1] * factor + intercept));
    d[i+2] = Math.min(255, Math.max(0, d[i+2] * factor + intercept));
  }
  ctx.putImageData(imageData, 0, 0);
}

let lastScanTime = 0;

function startBarcodeDetection() {
  if ('BarcodeDetector' in window) {
    const detector = new BarcodeDetector({ formats: ['pdf417', 'code_128', 'code_39', 'qr_code', 'data_matrix'] });
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    let frameCount = 0;

    const detect = async () => {
      if (!scanning) return;
      if (video.readyState < 2) { requestAnimationFrame(detect); return; }

      frameCount++;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      // Every 3rd frame, enhance contrast for a better read
      if (frameCount % 3 === 0) enhanceFrame(ctx, canvas.width, canvas.height);

      try {
        const codes = await detector.detect(canvas);
        if (codes.length > 0) {
          const now = Date.now();
          if (now - lastScanTime > 2000) { // debounce: don't re-fire within 2s
            lastScanTime = now;
            // Flash green frame
            const frame = document.getElementById('scan-frame');
            frame.classList.add('detected');
            setTimeout(() => frame.classList.remove('detected'), 800);
            // Vibrate if supported
            if (navigator.vibrate) navigator.vibrate([80, 30, 80]);
            handleBarcode(codes[0].rawValue);
          }
        } else {
          // Update status indicator
          const status = document.getElementById('scan-status');
          if (status) status.textContent = frameCount % 60 < 30 ? 'SCANNING...' : 'LOOKING FOR BARCODE...';
        }
      } catch(e) {}

      // Use requestAnimationFrame for fastest possible scan (~60fps attempts)
      setTimeout(() => requestAnimationFrame(detect), 80);
    };

    requestAnimationFrame(detect);
  } else {
    document.getElementById('scan-status').textContent = 'USE UPLOAD OR DEMO';
    showToast('Native scanner not available. Use Upload or Demo.', 'info');
  }
}

function handleUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const img = new Image();
  const url = URL.createObjectURL(file);
  img.onload = async () => {
    const canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    canvas.getContext('2d').drawImage(img, 0, 0);
    if ('BarcodeDetector' in window) {
      try {
        const detector = new BarcodeDetector({ formats: ['pdf417', 'code_128', 'code_39'] });
        const codes = await detector.detect(canvas);
        if (codes.length > 0) {
          handleBarcode(codes[0].rawValue);
        } else {
          showToast('No barcode found in image. Try Demo.', 'error');
        }
      } catch(e) { showToast('Barcode detection failed. Try Demo.', 'error'); }
    } else {
      showToast('BarcodeDetector not supported. Try Demo.', 'error');
    }
    URL.revokeObjectURL(url);
  };
  img.src = url;
}

// ---- BARCODE PARSING (AAMVA PDF417 format) ----
function handleBarcode(raw) {
  if (scanning) stopCamera();
  const data = parseAAMVA(raw);
  showParsedData(data);
}

function parseAAMVA(raw) {
  // AAMVA standard parsing
  const fields = {
    firstName: extractField(raw, 'DAC') || extractField(raw, 'DCT') || '',
    lastName: extractField(raw, 'DCS') || extractField(raw, 'DAB') || '',
    middleName: extractField(raw, 'DAD') || '',
    address: extractField(raw, 'DAG') || '',
    city: extractField(raw, 'DAI') || '',
    state: extractField(raw, 'DAJ') || '',
    zip: extractField(raw, 'DAK') || '',
    dob: formatDate(extractField(raw, 'DBB') || extractField(raw, 'DBA') || ''),
    licenseNum: extractField(raw, 'DAQ') || extractField(raw, 'DCF') || '',
    expiry: formatDate(extractField(raw, 'DBA') || ''),
    country: extractField(raw, 'DCG') || 'USA',
    sex: extractField(raw, 'DBC') === '1' ? 'Male' : extractField(raw, 'DBC') === '2' ? 'Female' : '',
  };

  // If parsing fails, just store raw
  if (!fields.lastName && !fields.address) {
    fields.rawData = raw.substring(0, 100);
  }

  return fields;
}

function extractField(raw, code) {
  const regex = new RegExp(code + '([^\\n\\r]+)', 'i');
  const match = raw.match(regex);
  return match ? match[1].trim() : '';
}

function formatDate(d) {
  if (!d || d.length < 8) return d;
  // MMDDYYYY ‚Üí MM/DD/YYYY
  if (d.length === 8) return `${d.slice(0,2)}/${d.slice(2,4)}/${d.slice(4)}`;
  return d;
}

function showParsedData(data) {
  parsedData = data;
  const grid = document.getElementById('info-grid');
  const fullAddress = [data.address, data.city, data.state, data.zip].filter(Boolean).join(', ');

  grid.innerHTML = `
    <div class="info-field">
      <div class="field-label">First Name</div>
      <div class="field-value">${data.firstName || '‚Äî'}</div>
    </div>
    <div class="info-field">
      <div class="field-label">Last Name</div>
      <div class="field-value">${data.lastName || '‚Äî'}</div>
    </div>
    <div class="info-field full">
      <div class="field-label">Address</div>
      <div class="field-value">${fullAddress || data.address || '‚Äî'}</div>
    </div>
    <div class="info-field">
      <div class="field-label">Date of Birth</div>
      <div class="field-value">${data.dob || '‚Äî'}</div>
    </div>
    <div class="info-field">
      <div class="field-label">License #</div>
      <div class="field-value">${data.licenseNum || '‚Äî'}</div>
    </div>
    ${data.expiry ? `<div class="info-field"><div class="field-label">Expiry</div><div class="field-value">${data.expiry}</div></div>` : ''}
    ${data.state ? `<div class="info-field"><div class="field-label">State</div><div class="field-value">${data.state}</div></div>` : ''}
    ${data.rawData ? `<div class="info-field full"><div class="field-label">Raw Data (preview)</div><div class="field-value" style="font-size:10px;opacity:0.7">${data.rawData}...</div></div>` : ''}
  `;

  document.getElementById('parsed-info').classList.add('visible');
  document.getElementById('category-section').classList.add('visible');
  document.getElementById('save-btn').classList.add('visible');
  selectedCategory = null;
  ['how','electronics','recycle'].forEach(c => {
    document.getElementById('cat-'+c).className = 'cat-btn';
  });
}

// ---- DEMO ----
function useDemo() {
  const demoRaw = `@

ANSI 636014080102DL00410232ZC03200021DLDAQD12345678
DCSPUBLIC
DACJOHN
DADQ
DAGUNIT 400 FIRST ST
DAICAPITAL CITY
DAJCA
DAK90210    
DARD
DAS
DAT
DAU506
DAVDBB01151990
DBC1
DAD`;
  handleBarcode(demoRaw);
  showToast('Demo data loaded!', 'success');
}

// ---- CATEGORY ----
function selectCategory(cat) {
  selectedCategory = cat;
  ['how','electronics','recycle'].forEach(c => {
    const btn = document.getElementById('cat-'+c);
    btn.className = 'cat-btn';
  });
  document.getElementById('cat-'+cat).className = `cat-btn selected ${cat}`;
}

// ---- SAVE ----
function saveRecord() {
  if (!parsedData) return;
  const fullAddress = [parsedData.address, parsedData.city, parsedData.state, parsedData.zip].filter(Boolean).join(', ');
  const record = {
    id: Date.now(),
    firstName: parsedData.firstName,
    lastName: parsedData.lastName,
    address: fullAddress || parsedData.address || 'N/A',
    licenseNum: parsedData.licenseNum,
    dob: parsedData.dob,
    state: parsedData.state,
    category: selectedCategory,
    timestamp: new Date().toLocaleString()
  };

  const records = getRecords();
  records.unshift(record);
  localStorage.setItem('license_records', JSON.stringify(records));
  updateCount();
  renderRecords();
  showToast('‚úì Record saved!', 'success');

  // Reset
  parsedData = null;
  selectedCategory = null;
  document.getElementById('parsed-info').classList.remove('visible');
  document.getElementById('category-section').classList.remove('visible');
  document.getElementById('save-btn').classList.remove('visible');
}

// ---- STORAGE ----
function getRecords() {
  try { return JSON.parse(localStorage.getItem('license_records') || '[]'); }
  catch(e) { return []; }
}

function updateCount() {
  document.getElementById('count').textContent = getRecords().length;
}

function renderRecords() {
  const records = getRecords();
  const list = document.getElementById('records-list');
  if (records.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><p>No records yet.<br>Scan a driver's license to get started.</p></div>`;
    return;
  }
  list.innerHTML = records.map(r => {
    const catClass = r.category ? `cat-${r.category}` : 'cat-none';
    const catLabel = r.category ? r.category.toUpperCase() : 'NO CATEGORY';
    const catIcons = { how: 'üè†', electronics: 'üîå', recycle: '‚ôªÔ∏è' };
    const icon = catIcons[r.category] || '‚Äî';
    return `
      <div class="record-card">
        <div class="record-top">
          <div class="record-name">${r.firstName} ${r.lastName}</div>
          <span class="record-cat ${catClass}">${icon} ${catLabel}</span>
        </div>
        <div class="record-address">üìç ${r.address}</div>
        ${r.licenseNum ? `<div class="record-address">ü™™ License: ${r.licenseNum}</div>` : ''}
        ${r.state ? `<div class="record-address">üèõÔ∏è State: ${r.state}</div>` : ''}
        <div class="record-time">${r.timestamp}</div>
      </div>
    `;
  }).join('');
}

function clearAll() {
  if (confirm('Delete all records?')) {
    localStorage.removeItem('license_records');
    updateCount();
    renderRecords();
    showToast('All records cleared');
  }
}

// ---- UI HELPERS ----
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0 && tab === 'scan') || (i === 1 && tab === 'records'));
  });
  document.getElementById('panel-scan').classList.toggle('active', tab === 'scan');
  document.getElementById('panel-records').classList.toggle('active', tab === 'records');
  if (tab === 'records') renderRecords();
}

let toastTimeout;
function showToast(msg, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.background = type === 'error' ? 'var(--red)' : type === 'info' ? 'var(--accent)' : 'var(--green)';
  toast.style.color = type === 'info' ? '#000' : '#fff';
  toast.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => toast.classList.remove('show'), 2800);
}

// Init
updateCount();
</script>
</body>
</html>
