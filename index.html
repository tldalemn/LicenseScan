<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SCAN/ID</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:wght@300;400;500&display=swap');

  :root {
    --bg: #0a0e1a; --card: #1a2234; --accent: #00e5ff; --accent2: #7c3aed;
    --green: #10b981; --yellow: #f59e0b; --red: #ef4444;
    --text: #f1f5f9; --muted: #64748b; --border: rgba(255,255,255,0.07);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body { background: var(--bg); color: var(--text); font-family: 'DM Mono', monospace; min-height: 100vh; overflow-x: hidden; }

  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: 0;
  }

  .app { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 0 0 80px; }

  /* ---- HEADER ---- */
  header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(0,229,255,0.06) 0%, transparent 100%);
  }

  .header-row1 { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }

  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 18px; color: var(--accent); }
  .logo span { color: var(--text); opacity: 0.5; }

  .record-count { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 11px; color: var(--muted); }
  .record-count strong { color: var(--accent); }

  /* Location bar in header */
  .location-bar {
    display: flex; align-items: center; gap: 10px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px;
  }

  .location-bar-label {
    font-family: 'Syne', sans-serif; font-weight: 700;
    font-size: 10px; color: var(--muted);
    letter-spacing: 1px; text-transform: uppercase;
    white-space: nowrap;
  }

  .location-select {
    flex: 1; background: transparent; border: none;
    color: var(--text); font-family: 'Syne', sans-serif;
    font-weight: 700; font-size: 13px;
    appearance: none; -webkit-appearance: none;
    cursor: pointer; outline: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7' viewBox='0 0 10 7'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2364748b' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 0px center;
    padding-right: 18px;
  }

  .location-select option { background: #1a2234; color: var(--text); }

  .loc-indicator {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    background: var(--muted); transition: background 0.3s;
  }
  .loc-indicator.set { background: var(--green); box-shadow: 0 0 6px var(--green); }

  /* ---- TABS ---- */
  .tabs { display: flex; margin: 14px 20px 0; background: var(--card); border-radius: 12px; padding: 4px; border: 1px solid var(--border); }
  .tab { flex: 1; padding: 10px; text-align: center; font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; border-radius: 9px; cursor: pointer; transition: all 0.2s; color: var(--muted); border: none; background: none; }
  .tab.active { background: var(--accent); color: #000; }

  .panel { display: none; padding: 16px 20px; }
  .panel.active { display: block; }

  /* ---- SCAN AREA ---- */
  .scan-area { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; margin-bottom: 16px; }
  .scan-header { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
  .scan-icon { width: 32px; height: 32px; background: rgba(0,229,255,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
  .scan-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; }
  .scan-sub { font-size: 10px; color: var(--muted); margin-top: 2px; }

  #video-container { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; display: none; }
  #video-container.active { display: block; }
  #video { width: 100%; height: 100%; object-fit: cover; }
  .scan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
  .scan-frame { width: 80%; height: 60%; border: 2px solid var(--accent); border-radius: 8px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.5); position: relative; }
  .scan-frame.detected { border-color: var(--green) !important; box-shadow: 0 0 0 2000px rgba(0,0,0,0.5), 0 0 20px var(--green); }
  .scan-line { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: scanLine 1.2s ease-in-out infinite; }
  @keyframes scanLine { 0%{top:0} 50%{top:calc(100% - 2px)} 100%{top:0} }
  .scan-label { position: absolute; bottom: -28px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--accent); white-space: nowrap; letter-spacing: 1px; text-transform: uppercase; }
  .torch-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 8px 12px; color: #fff; font-size: 18px; cursor: pointer; z-index: 10; }
  .torch-btn.on { background: rgba(245,158,11,0.7); }
  .scan-status { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: var(--accent); font-size: 10px; padding: 4px 12px; border-radius: 20px; letter-spacing: 1px; white-space: nowrap; }
  .scan-placeholder { padding: 36px 20px; text-align: center; color: var(--muted); }
  .scan-placeholder .big-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
  .scan-placeholder p { font-size: 12px; line-height: 1.6; }
  .scan-actions { padding: 14px 16px; display: flex; gap: 8px; }

  .zoom-hint { background: rgba(0,229,255,0.07); border: 1px solid rgba(0,229,255,0.15); border-radius: 10px; padding: 10px 14px; margin-bottom: 14px; font-size: 11px; color: var(--muted); line-height: 1.6; display: none; }
  .zoom-hint.visible { display: block; }
  .zoom-hint strong { color: var(--accent); }

  /* No-location warning */
  .loc-warning { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 10px; padding: 10px 14px; margin-bottom: 14px; font-size: 11px; color: var(--yellow); display: none; }
  .loc-warning.visible { display: flex; align-items: center; gap: 8px; }

  .btn { flex: 1; padding: 13px 8px; border-radius: 10px; border: none; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 11px; letter-spacing: 0.5px; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:active { transform: scale(0.97); }
  .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }

  /* ---- PARSED INFO ---- */
  #parsed-info { background: var(--card); border: 1px solid rgba(0,229,255,0.2); border-radius: 16px; padding: 16px; margin-bottom: 14px; display: none; }
  #parsed-info.visible { display: block; }
  .info-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .info-field { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; border: 1px solid var(--border); }
  .info-field.full { grid-column: 1 / -1; }
  .field-label { font-size: 9px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
  .field-value { font-size: 13px; color: var(--text); word-break: break-word; }

  /* ---- MATERIALS ---- */
  .form-section { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 14px; display: none; }
  .form-section.visible { display: block; }
  .section-label { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px; color: var(--text); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

  .mat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .mat-btn {
    padding: 14px 10px; border-radius: 12px; border: 2px solid var(--border);
    background: rgba(255,255,255,0.02); color: var(--muted);
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 11px;
    text-align: center; cursor: pointer; transition: all 0.15s;
    display: flex; flex-direction: column; align-items: center; gap: 6px;
    -webkit-tap-highlight-color: transparent; user-select: none;
  }
  .mat-btn .mat-icon { font-size: 22px; }
  .mat-btn.selected[data-id="how"]             { border-color: #10b981; background: rgba(16,185,129,0.12); color: #10b981; }
  .mat-btn.selected[data-id="electronics"]     { border-color: #00e5ff; background: rgba(0,229,255,0.12); color: #00e5ff; }
  .mat-btn.selected[data-id="recycle"]         { border-color: #f59e0b; background: rgba(245,158,11,0.12); color: #f59e0b; }
  .mat-btn.selected[data-id="paper-shredding"] { border-color: #a855f7; background: rgba(168,85,247,0.12); color: #a855f7; }
  .mat-btn.selected[data-id="sharps"]          { border-color: #ef4444; background: rgba(239,68,68,0.12); color: #ef4444; }
  .mat-btn.selected[data-id="lawn-waste"]      { border-color: #84cc16; background: rgba(132,204,22,0.12); color: #84cc16; }
  .mat-btn.selected[data-id="tree-waste"]      { border-color: #f97316; background: rgba(249,115,22,0.12); color: #f97316; }

  .selected-summary { margin-top: 10px; font-size: 11px; color: var(--muted); min-height: 18px; }
  .selected-summary strong { color: var(--accent); }

  /* ---- SAVE ---- */
  #save-btn { width: 100%; padding: 17px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 14px; letter-spacing: 1px; border: none; cursor: pointer; transition: all 0.2s; display: none; text-transform: uppercase; }
  #save-btn.visible { display: block; }
  #save-btn:active { transform: scale(0.98); }

  /* ---- TOAST ---- */
  .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); padding: 12px 24px; border-radius: 50px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px; opacity: 0; transition: all 0.3s; z-index: 100; white-space: nowrap; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* ---- RECORDS ---- */
  .records-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; flex-wrap: wrap; gap: 8px; }
  .records-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 16px; }
  .records-actions { display: flex; gap: 8px; }

  .export-btn { font-size: 11px; color: var(--green); background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); cursor: pointer; font-family: 'Syne', sans-serif; font-weight: 700; padding: 6px 12px; border-radius: 6px; }
  .clear-btn { font-size: 11px; color: var(--red); background: none; border: 1px solid rgba(239,68,68,0.3); cursor: pointer; font-family: 'DM Mono', monospace; padding: 6px 10px; border-radius: 6px; }

  .record-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 10px; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .record-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
  .record-name { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; }
  .record-location { font-size: 10px; background: rgba(0,229,255,0.1); color: var(--accent); padding: 3px 9px; border-radius: 20px; font-family: 'Syne', sans-serif; font-weight: 700; white-space: nowrap; }
  .record-address { font-size: 11px; color: var(--muted); line-height: 1.6; }
  .record-materials { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
  .mat-tag { font-size: 10px; padding: 3px 8px; border-radius: 20px; font-family: 'Syne', sans-serif; font-weight: 700; }
  .mat-tag.how             { background: rgba(16,185,129,0.15); color: #10b981; }
  .mat-tag.electronics     { background: rgba(0,229,255,0.15); color: #00e5ff; }
  .mat-tag.recycle         { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .mat-tag.paper-shredding { background: rgba(168,85,247,0.15); color: #a855f7; }
  .mat-tag.sharps          { background: rgba(239,68,68,0.15); color: #ef4444; }
  .mat-tag.lawn-waste      { background: rgba(132,204,22,0.15); color: #84cc16; }
  .mat-tag.tree-waste      { background: rgba(249,115,22,0.15); color: #f97316; }
  .record-time { font-size: 10px; color: var(--muted); margin-top: 8px; opacity: 0.6; }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  .empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
  .empty-state p { font-size: 12px; line-height: 1.7; }

  #upload-input { display: none; }
</style>
</head>
<body>
<div class="app">

  <!-- ===== HEADER ===== -->
  <header>
    <div class="header-row1">
      <div class="logo">SCAN<span>/</span>ID</div>
      <div class="record-count">Records: <strong id="count">0</strong></div>
    </div>

    <!-- Persistent location selector -->
    <div class="location-bar">
      <div class="loc-indicator" id="loc-indicator"></div>
      <div class="location-bar-label">üìç Location</div>
      <select class="location-select" id="location-select" onchange="onLocationChange()">
        <option value="">‚Äî Select location ‚Äî</option>
        <option value="SEC">SEC</option>
        <option value="NEC">NEC</option>
        <option value="Stillwater">Stillwater</option>
        <option value="Mahtomedi">Mahtomedi</option>
      </select>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('scan')">üì∑ Scan</button>
    <button class="tab" onclick="switchTab('records')">üìã Records</button>
  </div>

  <!-- ===== SCAN PANEL ===== -->
  <div class="panel active" id="panel-scan">

    <!-- No location warning -->
    <div class="loc-warning" id="loc-warning">
      ‚ö†Ô∏è Please select a location at the top before scanning.
    </div>

    <div class="scan-area">
      <div class="scan-header">
        <div class="scan-icon">üìÑ</div>
        <div>
          <div class="scan-title">Driver's License</div>
          <div class="scan-sub">Point camera at PDF417 barcode on back</div>
        </div>
      </div>

      <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
        <button class="torch-btn" id="torch-btn" onclick="toggleTorch()">üî¶</button>
        <div class="scan-overlay">
          <div class="scan-frame" id="scan-frame">
            <div class="scan-line"></div>
            <div class="scan-label">Align barcode within frame</div>
          </div>
        </div>
        <div class="scan-status" id="scan-status">SCANNING...</div>
      </div>

      <div id="scan-placeholder" class="scan-placeholder">
        <div class="big-icon">ü™™</div>
        <p>Tap <strong>Start Camera</strong> and point at the<br><strong>barcode on the back</strong> of the license.</p>
      </div>

      <div class="scan-actions">
        <button class="btn btn-primary" id="scan-btn" onclick="startCamera()">Start Camera</button>
        <button class="btn btn-secondary" onclick="document.getElementById('upload-input').click()">Upload</button>
        <button class="btn btn-secondary" onclick="useDemo()">Demo</button>
      </div>
    </div>

    <div class="zoom-hint" id="zoom-hint">
      üí° <strong>Tips:</strong> Hold 6‚Äì10 inches away ¬∑ Keep steady ¬∑ Good lighting ¬∑ Barcode is on the <strong>back</strong>
    </div>

    <input type="file" id="upload-input" accept="image/*" onchange="handleUpload(event)">

    <!-- Parsed Info -->
    <div id="parsed-info">
      <div class="info-title">‚úì Parsed Information</div>
      <div class="info-grid" id="info-grid"></div>
    </div>

    <!-- Materials Multi-Select -->
    <div class="form-section" id="category-section">
      <div class="section-label">
        üóÇÔ∏è Materials
        <span style="font-size:10px;color:var(--muted);font-weight:400">(select all that apply)</span>
      </div>
      <div class="mat-grid">
        <button class="mat-btn" data-id="how"             onclick="toggleMaterial(this)"><span class="mat-icon">üè†</span>HOW</button>
        <button class="mat-btn" data-id="electronics"     onclick="toggleMaterial(this)"><span class="mat-icon">üîå</span>ELECTRONICS</button>
        <button class="mat-btn" data-id="recycle"         onclick="toggleMaterial(this)"><span class="mat-icon">‚ôªÔ∏è</span>RECYCLE</button>
        <button class="mat-btn" data-id="paper-shredding" onclick="toggleMaterial(this)"><span class="mat-icon">üìÑ</span>PAPER SHREDDING</button>
        <button class="mat-btn" data-id="sharps"          onclick="toggleMaterial(this)"><span class="mat-icon">üíâ</span>SHARPS</button>
        <button class="mat-btn" data-id="lawn-waste"      onclick="toggleMaterial(this)"><span class="mat-icon">üåø</span>LAWN WASTE</button>
        <button class="mat-btn" data-id="tree-waste"      onclick="toggleMaterial(this)"><span class="mat-icon">üå≥</span>TREE WASTE</button>
      </div>
      <div class="selected-summary" id="selected-summary">No materials selected</div>
    </div>

    <button class="btn" id="save-btn" onclick="saveRecord()">üíæ Save Record</button>

  </div>

  <!-- ===== RECORDS PANEL ===== -->
  <div class="panel" id="panel-records">
    <div class="records-header">
      <div class="records-title">Records</div>
      <div class="records-actions">
        <button class="export-btn" onclick="exportCSV()">‚¨á Export CSV</button>
        <button class="clear-btn" onclick="clearAll()">Clear All</button>
      </div>
    </div>
    <div id="records-list"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
const MATERIAL_LABELS = {
  'how': 'HOW', 'electronics': 'Electronics', 'recycle': 'Recycle',
  'paper-shredding': 'Paper Shredding', 'sharps': 'Sharps',
  'lawn-waste': 'Lawn Waste', 'tree-waste': 'Tree Waste'
};

let stream = null, scanning = false, torchOn = false;
let parsedData = null, selectedMaterials = new Set(), lastScanTime = 0;

// ---- LOCATION (session-persistent) ----
function onLocationChange() {
  const loc = document.getElementById('location-select').value;
  sessionStorage.setItem('scan_location', loc);
  document.getElementById('loc-indicator').classList.toggle('set', !!loc);
  // Hide warning if location now set
  if (loc) document.getElementById('loc-warning').classList.remove('visible');
}

function getLocation() {
  return document.getElementById('location-select').value;
}

function initLocation() {
  const saved = sessionStorage.getItem('scan_location');
  if (saved) {
    document.getElementById('location-select').value = saved;
    document.getElementById('loc-indicator').classList.add('set');
  }
}

// ---- CAMERA ----
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 } }
    });
    const video = document.getElementById('video');
    video.srcObject = stream;
    document.getElementById('video-container').classList.add('active');
    document.getElementById('scan-placeholder').style.display = 'none';
    document.getElementById('zoom-hint').classList.add('visible');
    document.getElementById('scan-btn').textContent = 'Stop Camera';
    document.getElementById('scan-btn').onclick = stopCamera;
    scanning = true;
    const track = stream.getVideoTracks()[0];
    if (track.getCapabilities?.().focusMode) {
      track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }).catch(() => {});
    }
    startBarcodeDetection();
  } catch(e) { showToast('Camera error: ' + e.message, 'error'); }
}

function stopCamera() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  scanning = false; torchOn = false;
  document.getElementById('video-container').classList.remove('active');
  document.getElementById('scan-placeholder').style.display = 'block';
  document.getElementById('zoom-hint').classList.remove('visible');
  document.getElementById('scan-btn').textContent = 'Start Camera';
  document.getElementById('scan-btn').onclick = startCamera;
  document.getElementById('torch-btn').classList.remove('on');
}

async function toggleTorch() {
  if (!stream) return;
  const track = stream.getVideoTracks()[0];
  const caps = track.getCapabilities?.() || {};
  if (!caps.torch) { showToast('Torch not supported', 'info'); return; }
  torchOn = !torchOn;
  await track.applyConstraints({ advanced: [{ torch: torchOn }] }).catch(() => {});
  document.getElementById('torch-btn').classList.toggle('on', torchOn);
}

function enhanceFrame(ctx, w, h) {
  const d = ctx.getImageData(0, 0, w, h), px = d.data, f = 1.4, ic = 128*(1-f);
  for (let i = 0; i < px.length; i += 4) {
    px[i]   = Math.min(255, Math.max(0, px[i]   * f + ic));
    px[i+1] = Math.min(255, Math.max(0, px[i+1] * f + ic));
    px[i+2] = Math.min(255, Math.max(0, px[i+2] * f + ic));
  }
  ctx.putImageData(d, 0, 0);
}

function startBarcodeDetection() {
  if (!('BarcodeDetector' in window)) {
    document.getElementById('scan-status').textContent = 'USE UPLOAD OR DEMO';
    showToast('Scanner unavailable. Use Upload or Demo.', 'info'); return;
  }
  const detector = new BarcodeDetector({ formats: ['pdf417','code_128','code_39','qr_code','data_matrix'] });
  const video = document.getElementById('video');
  const canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
  let fc = 0;
  const detect = async () => {
    if (!scanning) return;
    if (video.readyState < 2) { requestAnimationFrame(detect); return; }
    fc++;
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    if (fc % 3 === 0) enhanceFrame(ctx, canvas.width, canvas.height);
    try {
      const codes = await detector.detect(canvas);
      if (codes.length > 0) {
        const now = Date.now();
        if (now - lastScanTime > 2000) {
          lastScanTime = now;
          const frame = document.getElementById('scan-frame');
          frame.classList.add('detected');
          setTimeout(() => frame.classList.remove('detected'), 800);
          if (navigator.vibrate) navigator.vibrate([80, 30, 80]);
          handleBarcode(codes[0].rawValue);
        }
      } else {
        const s = document.getElementById('scan-status');
        if (s) s.textContent = fc % 60 < 30 ? 'SCANNING...' : 'LOOKING FOR BARCODE...';
      }
    } catch(e) {}
    setTimeout(() => requestAnimationFrame(detect), 80);
  };
  requestAnimationFrame(detect);
}

// ---- UPLOAD ----
function handleUpload(event) {
  const file = event.target.files[0]; if (!file) return;
  const img = new Image(), url = URL.createObjectURL(file);
  img.onload = async () => {
    const canvas = document.createElement('canvas');
    canvas.width = img.width; canvas.height = img.height;
    canvas.getContext('2d').drawImage(img, 0, 0);
    if ('BarcodeDetector' in window) {
      try {
        const codes = await new BarcodeDetector({ formats: ['pdf417','code_128','code_39'] }).detect(canvas);
        if (codes.length > 0) handleBarcode(codes[0].rawValue);
        else showToast('No barcode found. Try Demo.', 'error');
      } catch(e) { showToast('Detection failed. Try Demo.', 'error'); }
    } else showToast('Not supported. Try Demo.', 'error');
    URL.revokeObjectURL(url);
  };
  img.src = url;
}

// ---- PARSE ----
function handleBarcode(raw) { if (scanning) stopCamera(); showParsedData(parseAAMVA(raw)); }

function parseAAMVA(raw) {
  const f = {
    firstName:  extractField(raw,'DAC') || extractField(raw,'DCT') || '',
    lastName:   extractField(raw,'DCS') || extractField(raw,'DAB') || '',
    address:    extractField(raw,'DAG') || '',
    city:       extractField(raw,'DAI') || '',
    state:      extractField(raw,'DAJ') || '',
    zip:        extractField(raw,'DAK') || '',
    dob:        formatDate(extractField(raw,'DBB') || ''),
    licenseNum: extractField(raw,'DAQ') || extractField(raw,'DCF') || '',
    expiry:     formatDate(extractField(raw,'DBA') || ''),
  };
  if (!f.lastName && !f.address) f.rawData = raw.substring(0, 100);
  return f;
}

function extractField(raw, code) {
  const m = raw.match(new RegExp(code + '([^\\n\\r]+)', 'i'));
  return m ? m[1].trim() : '';
}

function formatDate(d) {
  if (!d || d.length < 8) return d;
  if (d.length === 8) return `${d.slice(0,2)}/${d.slice(2,4)}/${d.slice(4)}`;
  return d;
}

function showParsedData(data) {
  parsedData = data;
  const addr = [data.address, data.city, data.state, data.zip].filter(Boolean).join(', ');
  document.getElementById('info-grid').innerHTML = `
    <div class="info-field"><div class="field-label">First Name</div><div class="field-value">${data.firstName||'‚Äî'}</div></div>
    <div class="info-field"><div class="field-label">Last Name</div><div class="field-value">${data.lastName||'‚Äî'}</div></div>
    <div class="info-field full"><div class="field-label">Address</div><div class="field-value">${addr||'‚Äî'}</div></div>
    <div class="info-field"><div class="field-label">Date of Birth</div><div class="field-value">${data.dob||'‚Äî'}</div></div>
    <div class="info-field"><div class="field-label">License #</div><div class="field-value">${data.licenseNum||'‚Äî'}</div></div>
    ${data.expiry?`<div class="info-field"><div class="field-label">Expiry</div><div class="field-value">${data.expiry}</div></div>`:''}
    ${data.state?`<div class="info-field"><div class="field-label">State</div><div class="field-value">${data.state}</div></div>`:''}
    ${data.rawData?`<div class="info-field full"><div class="field-label">Raw Preview</div><div class="field-value" style="font-size:10px;opacity:0.7">${data.rawData}...</div></div>`:''}
  `;
  document.getElementById('parsed-info').classList.add('visible');
  document.getElementById('category-section').classList.add('visible');
  document.getElementById('save-btn').classList.add('visible');
  selectedMaterials.clear();
  document.querySelectorAll('.mat-btn').forEach(b => b.classList.remove('selected'));
  document.getElementById('selected-summary').textContent = 'No materials selected';
}

// ---- DEMO ----
function useDemo() {
  handleBarcode(`@\n\nANSI 636014080102DL00410232ZC03200021DLDAQD12345678\nDCSPUBLIC\nDACJANE\nDAGUNIT 400 FIRST ST\nDAISTILLWATER\nDAJMN\nDAK55082\nDBB06221988\nDBA12252026\nDBC2`);
  showToast('Demo data loaded!', 'success');
}

// ---- MATERIALS ----
function toggleMaterial(btn) {
  const id = btn.dataset.id;
  if (selectedMaterials.has(id)) { selectedMaterials.delete(id); btn.classList.remove('selected'); }
  else { selectedMaterials.add(id); btn.classList.add('selected'); }
  const el = document.getElementById('selected-summary');
  if (selectedMaterials.size === 0) {
    el.textContent = 'No materials selected';
  } else {
    el.innerHTML = `<strong>${selectedMaterials.size}</strong> selected: ${[...selectedMaterials].map(id => MATERIAL_LABELS[id]).join(', ')}`;
  }
}

// ---- SAVE ----
function saveRecord() {
  if (!parsedData) return;

  // Warn if no location
  if (!getLocation()) {
    document.getElementById('loc-warning').classList.add('visible');
    showToast('Please select a location first!', 'error');
    window.scrollTo({ top: 0, behavior: 'smooth' });
    return;
  }

  const addr = [parsedData.address, parsedData.city, parsedData.state, parsedData.zip].filter(Boolean).join(', ');
  const record = {
    id: Date.now(),
    firstName: parsedData.firstName, lastName: parsedData.lastName,
    address: addr || parsedData.address || 'N/A',
    licenseNum: parsedData.licenseNum, dob: parsedData.dob, state: parsedData.state,
    location: getLocation(),
    materials: [...selectedMaterials],
    timestamp: new Date().toLocaleString()
  };

  const records = getRecords();
  records.unshift(record);
  localStorage.setItem('license_records', JSON.stringify(records));
  updateCount(); renderRecords();
  showToast('‚úì Record saved!', 'success');

  parsedData = null; selectedMaterials.clear();
  ['parsed-info','category-section'].forEach(id => document.getElementById(id).classList.remove('visible'));
  document.getElementById('save-btn').classList.remove('visible');
}

// ---- STORAGE ----
function getRecords() { try { return JSON.parse(localStorage.getItem('license_records')||'[]'); } catch(e) { return []; } }
function updateCount() { document.getElementById('count').textContent = getRecords().length; }

function renderRecords() {
  const records = getRecords();
  const list = document.getElementById('records-list');
  if (!records.length) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üì≠</div><p>No records yet.<br>Scan a driver's license to get started.</p></div>`;
    return;
  }
  list.innerHTML = records.map(r => `
    <div class="record-card">
      <div class="record-top">
        <div class="record-name">${r.firstName} ${r.lastName}</div>
        ${r.location ? `<span class="record-location">üìç ${r.location}</span>` : ''}
      </div>
      <div class="record-address">üè† ${r.address}</div>
      ${r.licenseNum ? `<div class="record-address">ü™™ ${r.licenseNum}</div>` : ''}
      ${(r.materials||[]).length ? `<div class="record-materials">${r.materials.map(m=>`<span class="mat-tag ${m}">${MATERIAL_LABELS[m]||m}</span>`).join('')}</div>` : ''}
      <div class="record-time">${r.timestamp}</div>
    </div>
  `).join('');
}

function clearAll() {
  if (confirm('Delete all records?')) {
    localStorage.removeItem('license_records');
    updateCount(); renderRecords();
    showToast('All records cleared');
  }
}

// ---- CSV EXPORT ----
const MATERIAL_IDS = ['how','electronics','recycle','paper-shredding','sharps','lawn-waste','tree-waste'];

function exportCSV() {
  const records = getRecords();
  if (!records.length) { showToast('No records to export', 'info'); return; }

  // One column per material, TRUE/FALSE
  const matHeaders = MATERIAL_IDS.map(id => MATERIAL_LABELS[id]);
  const headers = ['First Name','Last Name','Address','License #','DOB','State','Location',...matHeaders,'Timestamp'];

  const rows = records.map(r => {
    const mats = r.materials || [];
    const matCols = MATERIAL_IDS.map(id => mats.includes(id) ? 'TRUE' : 'FALSE');
    return [
      r.firstName, r.lastName, r.address, r.licenseNum,
      r.dob, r.state, r.location,
      ...matCols,
      r.timestamp
    ].map(v => `"${(v||'').replace(/"/g,'""')}"`);
  });

  const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `scan-id-records-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('‚úì Exported ' + records.length + ' records', 'success');
}

// ---- UI ----
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', (i===0&&tab==='scan')||(i===1&&tab==='records')));
  document.getElementById('panel-scan').classList.toggle('active', tab==='scan');
  document.getElementById('panel-records').classList.toggle('active', tab==='records');
  if (tab==='records') renderRecords();
}

let toastTimeout;
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = type==='error'?'var(--red)':type==='info'?'var(--accent)':'var(--green)';
  t.style.color = type==='info'?'#000':'#fff';
  t.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>t.classList.remove('show'), 2800);
}

// Init
initLocation();
updateCount();
</script>
</body>
</html>
